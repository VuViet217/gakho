{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container-fluid">
    <form method="post" id="receiptForm">
        {% csrf_token %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">{{ title }}</h3>
            </div>
            <div class="card-body">
                <!-- Thông tin đơn đặt hàng -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.purchase_order.id_for_label }}">Đơn đặt hàng <span class="text-danger">*</span></label>
                            {{ form.purchase_order }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="{{ form.receipt_date.id_for_label }}">Ngày nhập kho <span class="text-danger">*</span></label>
                            {{ form.receipt_date }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Nhà cung cấp</label>
                            <input type="text" class="form-control" id="supplier_display" readonly>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="{{ form.notes.id_for_label }}">Ghi chú</label>
                            {{ form.notes }}
                        </div>
                    </div>
                </div>

                <!-- Thông tin sản phẩm nhập kho -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title">Danh sách sản phẩm nhập kho</h3>
                    </div>
                    <div class="card-body">
                        {{ formset.management_form }}
                        <div class="table-responsive">
                            <table class="table table-bordered" id="items-table">
                                <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th width="100px">SL hiện tại</th>
                                        <th width="150px">SL nhập</th>
                                        <th width="200px">Ghi chú</th>
                                        <th width="80px">Xóa</th>
                                    </tr>
                                </thead>
                                <tbody id="item-rows">
                                    {% for form in formset %}
                                    <tr class="item-row" data-form-index="{{ forloop.counter0 }}">
                                        <td>
                                            {{ form.product }}
                                        </td>
                                        <td>
                                            {{ form.current_quantity }}
                                        </td>
                                        <td>
                                            {{ form.quantity }}
                                        </td>
                                        <td>
                                            {{ form.notes }}
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-danger btn-sm" onclick="xoaDongSanPham(this)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-info btn-lg" id="add-row-button" onclick="themDongSanPhamMoi()">
                                <i class="fas fa-plus-circle"></i> THÊM SẢN PHẨM MỚI
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Lưu phiếu nhập kho
                </button>
                <a href="{% url 'stock_receipt_list' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Hủy
                </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
// Lấy dữ liệu sản phẩm từ backend
window.productData = {{ products_data|safe }};
console.log("Dữ liệu sản phẩm từ backend:", window.productData);

// ĐỊNH NGHĨA HÀM Ở PHẠM VI GLOBAL
function xoaDongSanPham(button) {
    var itemRows = document.querySelectorAll('.item-row');
    if (itemRows.length > 1) {
        var row = button.closest('.item-row');
        row.remove();
        
        // Cập nhật lại TOTAL_FORMS
        var totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
        var newCount = document.querySelectorAll('.item-row').length;
        totalFormsInput.value = newCount;
        
        console.log("Đã xóa dòng sản phẩm. Còn lại:", newCount);
    } else {
        alert('Phải có ít nhất một sản phẩm!');
    }
}

function themDongSanPhamMoi() {
    console.log("===== BẮT ĐẦU THÊM DÒNG MỚI =====");
    
    try {
        // Lấy số lượng form hiện tại
        var totalFormsInput = document.getElementById('id_items-TOTAL_FORMS');
        if (!totalFormsInput) {
            console.error("Không tìm thấy trường TOTAL_FORMS!");
            return;
        }
        
        var formIdx = parseInt(totalFormsInput.value);
        console.log("Số form hiện tại:", formIdx);
        
        // Lấy dòng đầu tiên
        var itemRows = document.querySelectorAll('.item-row');
        if (itemRows.length === 0) {
            console.error("Không tìm thấy dòng sản phẩm nào!");
            return;
        }
        
        var firstRow = itemRows[0];
        console.log("Đã tìm thấy dòng đầu tiên");
        
        // Destroy Select2 trên dòng gốc trước khi clone
        var originalSelect = $(firstRow).find('select[name$="-product"]');
        if (originalSelect.length > 0 && originalSelect.data('select2')) {
            originalSelect.select2('destroy');
            console.log("Đã destroy Select2 trên dòng gốc");
        }
        
        // Clone dòng đầu tiên
        var newRow = firstRow.cloneNode(true);
        console.log("Đã clone dòng");
        
        // Cập nhật tất cả input/select trong dòng mới
        var inputs = newRow.querySelectorAll('input, select, textarea');
        inputs.forEach(function(input) {
            var name = input.getAttribute('name');
            if (name) {
                // Thay thế index cũ bằng index mới
                var newName = name.replace(/-\d+-/, '-' + formIdx + '-');
                var newId = 'id_' + newName;
                
                input.setAttribute('name', newName);
                input.setAttribute('id', newId);
                
                // Reset giá trị
                if (input.tagName === 'SELECT') {
                    input.value = '';
                } else if (input.type === 'number') {
                    input.value = '1';
                } else if (input.type !== 'hidden') {
                    input.value = '';
                }
            }
        });
        
        // Xóa các span Select2 còn sót lại trong dòng clone
        $(newRow).find('.select2-container').remove();
        
        // Thêm dòng mới vào cuối bảng
        var tbody = document.getElementById('item-rows');
        tbody.appendChild(newRow);
        console.log("Đã thêm dòng mới vào bảng");
        
        // Tăng số lượng form
        totalFormsInput.value = formIdx + 1;
        console.log("Đã cập nhật TOTAL_FORMS thành:", formIdx + 1);
        
        // Khởi tạo lại Select2 cho dòng gốc
        originalSelect.select2({
            theme: 'bootstrap4',
            width: '100%',
            placeholder: 'Chọn sản phẩm',
            allowClear: true,
            minimumResultsForSearch: 0
        });
        console.log("Đã khởi tạo lại Select2 cho dòng gốc");
        
        // Khởi tạo Select2 cho dropdown sản phẩm mới
        var newSelect = $(newRow).find('select[name$="-product"]');
        if (newSelect.length > 0) {
            newSelect.select2({
                theme: 'bootstrap4',
                width: '100%',
                placeholder: 'Chọn sản phẩm',
                allowClear: true,
                minimumResultsForSearch: 0
            });
            console.log("Đã khởi tạo Select2 cho dropdown mới");
        }
        
        console.log("===== HOÀN TẤT THÊM DÒNG MỚI =====");
        
    } catch (error) {
        console.error("Lỗi:", error);
    }
}

$(document).ready(function() {
    console.log("Trang tạo phiếu nhập kho đã sẵn sàng");
    console.log("Số lượng sản phẩm có sẵn:", Object.keys(window.productData).length);
    
    // Khởi tạo Select2 cho tất cả dropdown sản phẩm
    function initSelect2(selector) {
        $(selector).select2({
            theme: 'bootstrap4',
            width: '100%',
            placeholder: 'Chọn sản phẩm',
            allowClear: true,
            minimumResultsForSearch: 0  // Luôn hiển thị ô tìm kiếm
        });
        console.log("✓ Đã khởi tạo Select2 cho:", selector);
    }
    
    // Khởi tạo Select2 ngay lập tức
    initSelect2('select[name$="-product"]');
    
    // Xử lý khi chọn sản phẩm - cập nhật số lượng hiện tại
    $(document).on('change', 'select[name$="-product"]', function() {
        var productId = $(this).val();
        console.log("=== SẢN PHẨM ĐƯỢC CHỌN ===");
        console.log("Product ID:", productId);
        
        var row = $(this).closest('tr');
        
        if (productId) {
            console.log("Tìm sản phẩm ID", productId, "trong productData");
            console.log("ProductData:", window.productData);
            
            if (window.productData[productId]) {
                var currentQty = window.productData[productId].current_quantity;
                console.log("✓ Tìm thấy! Số lượng hiện tại:", currentQty);
                
                // Tìm ô input SL hiện tại
                var currentQtyInput = row.find('input[name$="-current_quantity"]');
                console.log("Số input current_quantity tìm thấy:", currentQtyInput.length);
                
                if (currentQtyInput.length > 0) {
                    currentQtyInput.val(currentQty);
                    console.log("✓ Đã set giá trị vào input:", currentQty);
                    console.log("✓ Giá trị hiện tại trong input:", currentQtyInput.val());
                } else {
                    console.error("❌ Không tìm thấy input current_quantity");
                }
            } else {
                console.warn("❌ Không tìm thấy thông tin cho sản phẩm ID:", productId);
                console.log("Các ID có sẵn:", Object.keys(window.productData));
            }
        } else {
            row.find('input[name$="-current_quantity"]').val('');
            console.log("Đã xóa số lượng hiện tại");
        }
    });
    
    // Cập nhật nhà cung cấp khi chọn PO
    $('#id_purchase_order').on('change', function() {
        var selectedText = $(this).find('option:selected').text();
        if (selectedText.includes(' - ')) {
            var supplier = selectedText.split(' - ')[1];
            $('#supplier_display').val(supplier);
        }
    });
    
    console.log("✓ Đã hoàn tất khởi tạo trang");
});
</script>
{% endblock %}
