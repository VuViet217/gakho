{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<style>
    .test-email-card {
        border-left: 4px solid #17a2b8;
    }
    .email-config-card {
        border-left: 4px solid #28a745;
    }
    .status-badge {
        font-size: 0.9rem;
    }
    .btn-info {
        background-color: #17a2b8;
        border-color: #17a2b8;
        color: #fff;
    }
    .btn-info:hover {
        background-color: #138496;
        border-color: #117a8b;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    
    {% if messages %}
    <div class="row">
        <div class="col-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="row">
        <!-- Cấu hình Email SMTP -->
        <div class="col-md-8">
            <div class="card card-outline card-success email-config-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-cogs mr-2"></i> Cấu hình SMTP Email
                    </h3>
                    
                    {% if config %}
                    <div class="card-tools">
                        {% if config.is_active %}
                        <span class="badge badge-success status-badge">
                            <i class="fas fa-check-circle"></i> Đang hoạt động
                        </span>
                        {% else %}
                        <span class="badge badge-danger status-badge">
                            <i class="fas fa-times-circle"></i> Đã vô hiệu hóa
                        </span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.smtp_host.id_for_label }}">{{ form.smtp_host.label }}</label>
                                    {{ form.smtp_host }}
                                    {% if form.smtp_host.errors %}
                                    <div class="text-danger">{{ form.smtp_host.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.smtp_port.id_for_label }}">{{ form.smtp_port.label }}</label>
                                    {{ form.smtp_port }}
                                    {% if form.smtp_port.errors %}
                                    <div class="text-danger">{{ form.smtp_port.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.auth_method.id_for_label }}">{{ form.auth_method.label }}</label>
                                    {{ form.auth_method }}
                                    {% if form.auth_method.errors %}
                                    <div class="text-danger">{{ form.auth_method.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="auth-credentials">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.smtp_username.id_for_label }}">{{ form.smtp_username.label }}</label>
                                        {{ form.smtp_username }}
                                        {% if form.smtp_username.errors %}
                                        <div class="text-danger">{{ form.smtp_username.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="{{ form.smtp_password.id_for_label }}">{{ form.smtp_password.label }}</label>
                                        {{ form.smtp_password }}
                                        {% if form.smtp_password.errors %}
                                        <div class="text-danger">{{ form.smtp_password.errors }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.from_email.id_for_label }}">{{ form.from_email.label }}</label>
                                    {{ form.from_email }}
                                    {% if form.from_email.errors %}
                                    <div class="text-danger">{{ form.from_email.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.smtp_conn_timeout.id_for_label }}">{{ form.smtp_conn_timeout.label }} <span class="text-danger">*</span></label>
                                    {{ form.smtp_conn_timeout }}
                                    {% if form.smtp_conn_timeout.errors %}
                                    <div class="text-danger">{{ form.smtp_conn_timeout.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.smtp_timeout.id_for_label }}">{{ form.smtp_timeout.label }} <span class="text-danger">*</span></label>
                                    {{ form.smtp_timeout }}
                                    {% if form.smtp_timeout.errors %}
                                    <div class="text-danger">{{ form.smtp_timeout.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6 mt-4">
                                <div class="form-check mr-4 d-inline">
                                    {{ form.use_tls }}
                                    <label class="form-check-label" for="{{ form.use_tls.id_for_label }}">
                                        {{ form.use_tls.label }}
                                    </label>
                                </div>
                                <div class="form-check mr-4 d-inline">
                                    {{ form.use_ssl }}
                                    <label class="form-check-label" for="{{ form.use_ssl.id_for_label }}">
                                        {{ form.use_ssl.label }}
                                    </label>
                                </div>
                                <div class="form-check d-inline">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        {{ form.is_active.label }}
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info-circle"></i> Hướng dẫn cấu hình</h5>
                            <ul class="mb-0">
                                <li><strong>Gmail:</strong> Host: smtp.gmail.com, Port: 587 (TLS), 465 (SSL)</li>
                                <li><strong>Outlook/Office365:</strong> Host: smtp.office365.com, Port: 587 (TLS)</li>
                                <li><strong>Yahoo:</strong> Host: smtp.mail.yahoo.com, Port: 587 (TLS)</li>
                                <li>Với Gmail, bạn cần tạo <a href="https://support.google.com/accounts/answer/185833" target="_blank">App Password</a></li>
                            </ul>
                        </div>
                        
                        {% if config and config.last_test_date %}
                        <div class="alert {% if config.last_test_success %}alert-success{% else %}alert-danger{% endif %}">
                            <h5><i class="icon fas {% if config.last_test_success %}fa-check{% else %}fa-exclamation-triangle{% endif %}"></i> 
                                Kết quả test gần nhất
                            </h5>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <p class="mb-0">
                                        {% if config.last_test_success %}
                                        Test thành công vào lúc: {{ config.last_test_date|date:"d/m/Y H:i:s" }}
                                        {% else %}
                                        Test thất bại vào lúc: {{ config.last_test_date|date:"d/m/Y H:i:s" }}
                                        {% endif %}
                                    </p>
                                    {% if messages %}
                                    <small class="text-muted">Kiểm tra log để biết thêm chi tiết</small>
                                    {% endif %}
                                </div>
                                <form method="post" class="ml-2">
                                    {% csrf_token %}
                                    <button type="submit" name="reset_test" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-redo"></i> Reset
                                    </button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                        
                        <button type="submit" name="save_config" class="btn btn-success">
                            <i class="fas fa-save mr-1"></i> Lưu cấu hình
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Test Email -->
        <div class="col-md-4">
            <div class="card card-outline card-info test-email-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-paper-plane mr-2"></i> Gửi email test
                    </h3>
                </div>
                <div class="card-body">
                    {% if not config or not config.is_active %}
                    <div class="alert alert-warning">
                        <h5><i class="icon fas fa-exclamation-triangle"></i> Chú ý!</h5>
                        <p class="mb-0">Bạn cần phải cấu hình và kích hoạt SMTP trước khi test gửi email.</p>
                    </div>
                    {% endif %}
                    
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="{{ test_form.recipient.id_for_label }}">{{ test_form.recipient.label }}</label>
                            {{ test_form.recipient }}
                            {% if test_form.recipient.errors %}
                            <div class="text-danger">{{ test_form.recipient.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ test_form.subject.id_for_label }}">{{ test_form.subject.label }}</label>
                            {{ test_form.subject }}
                            {% if test_form.subject.errors %}
                            <div class="text-danger">{{ test_form.subject.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="form-group">
                            <label for="{{ test_form.message.id_for_label }}">{{ test_form.message.label }}</label>
                            {{ test_form.message }}
                            {% if test_form.message.errors %}
                            <div class="text-danger">{{ test_form.message.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <button type="submit" name="test_email" class="btn btn-info btn-block" {% if not config or not config.is_active %}disabled{% endif %}>
                            <i class="fas fa-paper-plane mr-1"></i> Gửi email test
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Xử lý khi thay đổi checkbox TLS/SSL
    $('#id_use_tls, #id_use_ssl').on('change', function() {
        const useTLS = $('#id_use_tls').prop('checked');
        const useSSL = $('#id_use_ssl').prop('checked');
        const portField = $('#id_smtp_port');
        
        if (useTLS && useSSL) {
            alert("Không thể sử dụng cả TLS và SSL cùng lúc. Hãy chỉ chọn một trong hai.");
            $(this).prop('checked', false);
            return;
        }
        
        // Tự động đề xuất port phù hợp
        if (useTLS && !portField.val()) {
            portField.val(587);
        } else if (useSSL && !portField.val()) {
            portField.val(465);
        }
    });
    
    // Xử lý hiển thị/ẩn trường tài khoản/mật khẩu theo phương thức xác thực
    function toggleAuthFields() {
        const authMethod = $('#id_auth_method').val();
        
        if (authMethod === 'none') {
            $('.auth-credentials').hide();
        } else {
            $('.auth-credentials').show();
        }
    }
    
    // Chạy khi trang load và khi thay đổi lựa chọn
    toggleAuthFields();
    $('#id_auth_method').on('change', toggleAuthFields);
});
</script>
{% endblock %}